# DhSport Backend Apache 설정
# 파일 위치: /etc/apache2/sites-available/dhsport.conf (Ubuntu/Debian)
#          또는 /etc/httpd/conf.d/dhsport.conf (CentOS/RHEL)
#
# 필수 모듈 활성화:
#   sudo a2enmod proxy proxy_http proxy_wstunnel ssl headers rewrite
#
# 활성화: sudo a2ensite dhsport
# 테스트: sudo apachectl configtest
# 재시작: sudo systemctl reload apache2 (또는 httpd)

# HTTP 가상 호스트 (HTTPS로 리다이렉트)
<VirtualHost *:80>
    ServerName api.dhsport.com
    ServerAdmin admin@dhsport.com

    # Let's Encrypt 인증서 검증용
    DocumentRoot /var/www/html
    <Directory /var/www/html>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted
    </Directory>

    # ACME Challenge 디렉토리
    Alias /.well-known/acme-challenge/ /var/www/html/.well-known/acme-challenge/
    <Directory /var/www/html/.well-known/acme-challenge/>
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # 나머지 모든 요청은 HTTPS로 리다이렉트
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^ https://%{SERVER_NAME}%{REQUEST_URI} [L,R=301]

    # 로그 파일
    ErrorLog ${APACHE_LOG_DIR}/dhsport_error.log
    CustomLog ${APACHE_LOG_DIR}/dhsport_access.log combined
</VirtualHost>

# HTTPS 가상 호스트
<VirtualHost *:443>
    ServerName api.dhsport.com
    ServerAdmin admin@dhsport.com

    # SSL 엔진 활성화
    SSLEngine on

    # SSL 인증서 설정
    # Let's Encrypt 사용 시
    SSLCertificateFile /etc/letsencrypt/live/api.dhsport.com/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/api.dhsport.com/privkey.pem

    # 또는 자체 인증서 사용 시
    # SSLCertificateFile /etc/ssl/dhsport/dhsport.crt
    # SSLCertificateKeyFile /etc/ssl/dhsport/dhsport.key
    # SSLCertificateChainFile /etc/ssl/dhsport/dhsport-chain.crt

    # SSL 프로토콜 및 암호화 설정
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305
    SSLHonorCipherOrder off
    SSLCompression off
    SSLSessionTickets off

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    # 보안 헤더
    Header always set Strict-Transport-Security "max-age=63072000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"

    # 로그 파일
    ErrorLog ${APACHE_LOG_DIR}/dhsport_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/dhsport_ssl_access.log combined

    # 업로드 파일 크기 제한 (10MB)
    LimitRequestBody 10485760

    # 타임아웃 설정
    ProxyTimeout 60
    TimeOut 60

    # API 프록시 설정
    ProxyPreserveHost On
    ProxyRequests Off

    # WebSocket 지원
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} websocket [NC]
    RewriteCond %{HTTP:Connection} upgrade [NC]
    RewriteRule ^/?(.*) "ws://localhost:5000/$1" [P,L]

    # HTTP 프록시
    ProxyPass /uploads/ !
    ProxyPass / http://localhost:5000/
    ProxyPassReverse / http://localhost:5000/

    # 프록시 헤더 설정
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"

    <Location />
        # 헤더 전달
        ProxyAddHeaders On

        # 타임아웃
        ProxyPassReverseCookieDomain localhost api.dhsport.com
    </Location>

    # 정적 파일 직접 서빙 (업로드 파일)
    Alias /uploads/ /opt/dhsport/uploads/
    <Directory /opt/dhsport/uploads/>
        Options -Indexes +FollowSymLinks
        AllowOverride None
        Require all granted

        # 캐시 설정
        <IfModule mod_expires.c>
            ExpiresActive On
            ExpiresDefault "access plus 30 days"
        </IfModule>

        # 캐시 제어 헤더
        Header set Cache-Control "public, immutable"

        # 보안: 실행 파일 접근 차단
        <FilesMatch "\.(php|pl|py|jsp|asp|sh|cgi)$">
            Require all denied
        </FilesMatch>
    </Directory>

    # 로그 디렉토리 접근 차단
    <Directory /opt/dhsport/logs/>
        Require all denied
    </Directory>

    # .git 디렉토리 접근 차단
    <DirectoryMatch "^/.*/\.git/">
        Require all denied
    </DirectoryMatch>

    # 숨김 파일 접근 차단
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>

    # 압축 설정
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/plain
        AddOutputFilterByType DEFLATE text/html
        AddOutputFilterByType DEFLATE text/xml
        AddOutputFilterByType DEFLATE text/css
        AddOutputFilterByType DEFLATE text/javascript
        AddOutputFilterByType DEFLATE application/xml
        AddOutputFilterByType DEFLATE application/xhtml+xml
        AddOutputFilterByType DEFLATE application/rss+xml
        AddOutputFilterByType DEFLATE application/javascript
        AddOutputFilterByType DEFLATE application/x-javascript
        AddOutputFilterByType DEFLATE application/json
        AddOutputFilterByType DEFLATE image/svg+xml
    </IfModule>
</VirtualHost>

# OCSP Stapling 캐시 (전역 설정)
<IfModule mod_ssl.c>
    SSLStaplingCache shmcb:/var/run/apache2/stapling_cache(128000)
</IfModule>
